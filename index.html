<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeCMo - Dental Clinic's Module Soft</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#f3f4f6; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:white; padding:40px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.1); text-align:center; max-width:400px; width:90%;">
        <div style="font-size:40px; color:#3b82f6; margin-bottom:10px;"><i class="fa-solid fa-tooth"></i></div>
        <h2 style="margin-bottom:10px; color:#1e293b;">DeCMo</h2>
        <span style="font-size: 12px; color: #64748b; display: block; margin-bottom: 20px;">(デクモ) Dental Clinic's Module Soft</span>
        <button id="login-btn" style="background:#3b82f6; color:white; border:none; padding:12px 24px; border-radius:6px; font-weight:bold; cursor:pointer; font-size:16px; width:100%; display:flex; align-items:center; justify-content:center; gap:10px; transition: opacity 0.2s;">
            <i class="fa-brands fa-google"></i> Googleでログイン
        </button>
        <p id="login-error" style="color:red; font-size:12px; margin-top:15px; display:none;"></p>
    </div>
</div>

<div class="app-container">
    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="logo-icon"><i class="fa-solid fa-tooth"></i></div>
            <div>
                <h1 class="logo-text">DeCMo</h1>
                <span style="font-size: 10px; color: var(--text-sub); display: block; line-height: 1;">(デクモ)</span>
            </div>
        </div>
        <ul class="menu-list">
            <li class="menu-item"><a href="#" data-target="goals"><i class="fa-solid fa-bullseye"></i><span>経営目標・理念</span></a></li>
            <li class="menu-item active"><a href="#" data-target="dashboard"><i class="fa-solid fa-chart-line"></i><span>診療数値</span></a></li>
            <li class="menu-item"><a href="#" data-target="accounting"><i class="fa-solid fa-calculator"></i><span>会計管理</span></a></li>
            <li class="menu-item"><a href="#" data-target="phr"><i class="fa-solid fa-mobile-screen-button"></i><span>患者PHRアプリ連携</span></a></li>
            <li class="menu-item"><a href="#" data-target="satisfaction"><i class="fa-regular fa-face-smile"></i><span>患者満足</span></a></li>
            <li class="menu-item"><a href="#" data-target="marketing"><i class="fa-solid fa-bullhorn"></i><span>マーケティング</span></a></li>
            <li class="menu-item"><a href="#" data-target="recruitment"><i class="fa-solid fa-user-doctor"></i><span>人材採用</span></a></li>
            <li class="menu-item"><a href="#" data-target="engagement"><i class="fa-solid fa-people-roof"></i><span>エンゲージメント</span></a></li>
            <li class="menu-item"><a href="#" data-target="ai-agent"><i class="fa-solid fa-robot"></i><span>AIエージェント</span></a></li>
        </ul>
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="avatar"><i class="fa-solid fa-user"></i></div>
                <div class="user-details"><span class="user-name">ゲスト</span><span class="user-role">管理者</span></div>
            </div>
            <button id="logout-btn" class="logout-btn" title="ログアウト"><i class="fa-solid fa-right-from-bracket"></i></button>
        </div>
    </nav>

    <main class="main-content">
        <header class="top-bar">
            <div><h2 id="page-title">診療数値ダッシュボード</h2></div>
            <div class="top-bar-controls" style="display: flex; align-items: center; gap: 20px;">
                <div class="month-selector" style="display: flex; align-items: center; background: white; padding: 5px 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--border-color);">
                    <button id="prev-month-btn" style="border:none; background:none; cursor:pointer; color:var(--text-sub); padding: 5px;"><i class="fa-solid fa-chevron-left"></i></button>
                    <input type="month" id="month-picker" style="border:none; font-family:inherit; font-weight:bold; color:var(--text-main); font-size:15px; cursor:pointer; outline:none; background:transparent;">
                    <button id="next-month-btn" style="border:none; background:none; cursor:pointer; color:var(--text-sub); padding: 5px;"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div class="date-display" id="current-date" style="font-weight:500; color:var(--text-sub); background: white; padding: 8px 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--border-color);">---</div>
                <button id="open-settings-btn" title="表示項目の設定" style="border:none; background:white; color:var(--text-sub); width:36px; height:36px; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.05); cursor:pointer; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-gear"></i></button>
                <button id="open-upload-btn" title="日計表を読み込む" style="margin-left:10px; border:none; background:white; color:var(--accent-blue); width:36px; height:36px; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.05); cursor:pointer; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-cloud-arrow-up"></i></button>
                <button id="open-input-btn" title="手動で数値を入力" style="margin-left:10px; border:none; background:white; color:var(--text-sub); width:36px; height:36px; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.05); cursor:pointer; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-pen-to-square"></i></button>
            </div>
        </header>

        <div class="content-body">
            
            <div id="page-dashboard">
                <div id="kpi-top-container" class="kpi-grid"></div>
                <h3 style="font-size: 16px; color: var(--text-sub); margin-bottom: 15px; border-left: 4px solid var(--accent-blue); padding-left: 10px;">詳細集計</h3>
                <div id="kpi-sub-container" class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-bottom: 30px;"></div>
                <div class="charts-grid">
                    <div class="card chart-card wide">
                        <div class="card-header"><h3>月次推移</h3></div>
                        <div class="chart-container"><canvas id="salesChart"></canvas></div>
                    </div>
                </div>
                <div class="ai-message-area" style="margin-top: 30px; margin-bottom: 50px;">
                    <div class="ai-card" style="display: flex; gap: 20px; background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); align-items: flex-start;">
                        <div class="ai-avatar" style="flex-shrink: 0; text-align: center;">
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #3b82f6, #0ea5e9); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);"><i class="fa-solid fa-robot" style="font-size: 30px; color: white;"></i></div>
                            <span style="font-size: 11px; font-weight: bold; color: var(--accent-blue);">DeCMo AI</span>
                        </div>
                        <div class="ai-content" style="flex: 1;">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px; color: var(--text-main); display: flex; align-items: center; gap: 8px;"><i class="fa-solid fa-sparkles" style="color: var(--accent-orange);"></i> 今月の経営アドバイス</h4>
                            <div id="ai-text-body" style="font-size: 14px; line-height: 1.6; color: var(--text-main); background: #f8fafc; padding: 15px; border-radius: 0 12px 12px 12px; border-left: 4px solid var(--accent-blue);">データを集計中です...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-goals" style="display:none;">
                <div class="card" style="padding: 30px; margin-bottom: 30px; border-left: 5px solid #8b5cf6;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="margin:0; font-size:18px; color:var(--text-main);"><i class="fa-solid fa-flag" style="margin-right:10px; color:#8b5cf6;"></i>医院理念・Mission</h3>
                        <button style="border:none; background:none; color:var(--text-sub); cursor:pointer;"><i class="fa-solid fa-pen"></i> 編集</button>
                    </div>
                    <p style="font-size:18px; font-weight:bold; color:#1e293b; line-height:1.8; text-align:center;">「患者様の生涯の健康パートナーとして、<br>心からの笑顔と安心を提供する歯科医院を目指す」</p>
                </div>
                <div class="kpi-grid">
                    <div class="card kpi-card"><div class="card-icon blue"><i class="fa-solid fa-users"></i></div><div class="card-info"><h3>ユニット1台生産性/月</h3><p class="value">250万円</p><span class="trend flat">目標: 300万円</span></div></div>
                    <div class="card kpi-card"><div class="card-icon green"><i class="fa-solid fa-clock"></i></div><div class="card-info"><h3>人時生産性</h3><p class="value">15,625円</p><span class="trend flat">目標: 10,000円</span></div></div>
                    <div class="card kpi-card"><div class="card-icon orange"><i class="fa-solid fa-user-nurse"></i></div><div class="card-info"><h3>スタッフ1人生産性</h3><p class="value">150万円</p><span class="trend flat">目標: 120万円</span></div></div>
                </div>
            </div>

            <div id="page-recruitment" style="display:none;">
                <div id="ai-recruitment-news" style="background:white; border-radius:8px; padding:15px; margin-bottom:20px; display:flex; align-items:center; gap:15px; border-left:4px solid var(--accent-purple); box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                    <div style="flex-shrink:0; background:var(--accent-purple); color:white; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div style="flex:1;">
                        <div style="font-size:11px; color:var(--accent-purple); font-weight:bold; margin-bottom:2px;">AI Recruitment News</div>
                        <div id="recruitment-news-text" style="font-size:13px; color:var(--text-main); font-weight:500;">
                            最新の採用市況を分析中...
                        </div>
                    </div>
                </div>

                <div class="kpi-grid">
                    <div class="card kpi-card" style="position:relative;">
                        <button id="btn-edit-recruit-kpi" style="position:absolute; top:10px; right:10px; border:none; background:none; color:#ccc; cursor:pointer;"><i class="fa-solid fa-pen"></i></button>
                        <div class="card-icon blue"><i class="fa-solid fa-users-viewfinder"></i></div>
                        <div class="card-info">
                            <h3>今月の応募 / 採用</h3>
                            <p class="value" id="disp-recruit-count">--/--</p>
                            <span class="trend up"><i class="fa-solid fa-arrow-trend-up"></i> 前月比 +4件</span>
                        </div>
                    </div>
                    <div class="card kpi-card">
                        <div class="card-icon orange"><i class="fa-solid fa-wallet"></i></div>
                        <div class="card-info">
                            <h3>平均採用単価 (CPA)</h3>
                            <p class="value" id="disp-recruit-cpa">--万円</p>
                            <span class="trend flat"><i class="fa-solid fa-minus"></i> 予算内</span>
                        </div>
                    </div>
                    <div class="card kpi-card">
                        <div class="card-icon green"><i class="fa-solid fa-filter"></i></div>
                        <div class="card-info">
                            <h3>選考歩留まり率</h3>
                            <p class="value" id="disp-recruit-rate">--%</p>
                            <span class="trend down"><i class="fa-solid fa-arrow-trend-down"></i> 応募→面接</span>
                        </div>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin:30px 0 15px 0;">
                    <h3 style="font-size:16px; color:var(--text-sub); border-left:4px solid var(--accent-blue); padding-left:10px; margin:0;">採用パイプライン</h3>
                    <button id="btn-edit-pipeline" style="border:none; background:none; color:#666; cursor:pointer; font-size:13px;"><i class="fa-solid fa-pen"></i> 編集</button>
                </div>
                <div id="pipeline-container" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">
                    </div>

                <div class="charts-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="card" style="min-height: 300px; display:flex; flex-direction:column;">
                        <div class="card-header" style="padding:20px 20px 0 20px; margin-bottom:10px;">
                            <h3>媒体別パフォーマンス</h3>
                            <button id="edit-recruitment-btn" style="border:none; background:none; cursor:pointer; color:#666; font-size:13px;">
                                <i class="fa-solid fa-pen"></i> 編集
                            </button>
                        </div>
                        <div class="chart-container" style="flex:1; padding:0 10px;">
                            <canvas id="recruitmentChart"></canvas>
                        </div>
                        <div id="media-links-area" style="padding:15px; border-top:1px solid #f0f0f0; display:flex; flex-wrap:wrap; gap:10px; background:#fcfcfc; border-radius:0 0 12px 12px;">
                            </div>
                    </div>
                    <div class="card" style="min-height: 300px; padding: 20px;">
                        <div class="card-header">
                            <h3>募集要項ステータス</h3>
                            <button id="btn-edit-jobs" style="border:none; background:none; cursor:pointer; color:#666; font-size:13px;">
                                <i class="fa-solid fa-pen"></i> 編集
                            </button>
                        </div>
                        <div id="job-list-container" style="display: flex; flex-direction: column; gap: 15px;">
                            </div>
                    </div>
                </div>
            </div>

            <div id="page-accounting" style="display:none;"><div class="card chart-card wide"><div class="card-header"><h3>月次損益</h3></div><div class="chart-container"><canvas id="accountingChart"></canvas></div></div></div>
            <div id="page-phr" style="display:none;"><div class="kpi-grid"><div class="card kpi-card"><div class="card-info"><h3>アプリ登録者</h3><p class="value">0</p></div></div></div></div>
            <div id="page-satisfaction" style="display:none;"><div class="kpi-grid"><div class="card kpi-card"><div class="card-info"><h3>NPS</h3><p class="value">+45</p></div></div></div></div>
            <div id="page-marketing" style="display:none;"><div class="card chart-card wide"><div class="card-header"><h3>流入経路</h3></div><div class="chart-container"><canvas id="marketingChart"></canvas></div></div></div>
            <div id="page-engagement" style="display:none;"><div class="card chart-card wide"><div class="card-header"><h3>満足度推移</h3></div><div class="chart-container"><canvas id="engagementChart"></canvas></div></div></div>

        </div>
    </main>
</div>

<div id="recruitment-edit-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:white; width:500px; max-width:90%; border-radius:12px; padding:25px; box-shadow:0 10px 25px rgba(0,0,0,0.2); display:flex; flex-direction:column; max-height:90vh;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">媒体データ編集</h3>
            <button id="close-recruitment-btn" style="border:none; background:none; font-size:24px; cursor:pointer; color:#999;">&times;</button>
        </div>
        <div id="recruitment-list" style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:10px; margin-bottom:15px;"></div>
        <div style="margin-bottom:15px;">
            <button id="add-recruitment-btn" style="width:100%; padding:8px; border:1px dashed #ddd; background:#fafafa; color:#666; border-radius:6px; cursor:pointer; font-size:13px;"><i class="fa-solid fa-plus"></i> 追加</button>
        </div>
        <div style="text-align:right; border-top:1px solid #eee; padding-top:15px;">
            <button id="save-recruitment-btn" style="background:var(--accent-blue); color:white; border:none; padding:10px 25px; border-radius:6px; font-weight:bold; cursor:pointer;">保存して反映</button>
        </div>
    </div>
</div>

<div id="recruit-kpi-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:white; width:400px; max-width:90%; border-radius:12px; padding:25px; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">採用KPI編集</h3>
            <button id="close-kpi-modal" style="border:none; background:none; font-size:24px; cursor:pointer; color:#999;">&times;</button>
        </div>
        <div style="display:flex; flex-direction:column; gap:15px;">
            <div><label style="font-size:12px; color:#666;">応募数</label><input type="number" id="edit-kpi-applicants" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;"></div>
            <div><label style="font-size:12px; color:#666;">採用数</label><input type="number" id="edit-kpi-hires" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;"></div>
            <div><label style="font-size:12px; color:#666;">採用単価(万円)</label><input type="number" id="edit-kpi-cpa" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;"></div>
            <div><label style="font-size:12px; color:#666;">歩留まり率(%)</label><input type="number" id="edit-kpi-rate" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;"></div>
        </div>
        <div style="text-align:right; margin-top:20px;">
            <button id="save-kpi-btn" style="background:var(--accent-blue); color:white; border:none; padding:10px 25px; border-radius:6px; font-weight:bold; cursor:pointer;">保存</button>
        </div>
    </div>
</div>

<div id="pipeline-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:white; width:600px; max-width:90%; border-radius:12px; padding:25px; box-shadow:0 10px 25px rgba(0,0,0,0.2); display:flex; flex-direction:column; max-height:90vh;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">パイプライン編集</h3>
            <button id="close-pipeline-modal" style="border:none; background:none; font-size:24px; cursor:pointer; color:#999;">&times;</button>
        </div>
        <div id="pipeline-edit-list" style="flex:1; overflow-y:auto; padding:5px;"></div>
        <div style="text-align:right; margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <button id="save-pipeline-btn" style="background:var(--accent-blue); color:white; border:none; padding:10px 25px; border-radius:6px; font-weight:bold; cursor:pointer;">保存</button>
        </div>
    </div>
</div>

<div id="job-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:white; width:500px; max-width:90%; border-radius:12px; padding:25px; box-shadow:0 10px 25px rgba(0,0,0,0.2); display:flex; flex-direction:column; max-height:90vh;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">募集要項ステータス編集</h3>
            <button id="close-job-modal" style="border:none; background:none; font-size:24px; cursor:pointer; color:#999;">&times;</button>
        </div>
        <div id="job-edit-list" style="flex:1; overflow-y:auto; padding:5px;"></div>
        <div style="margin-top:10px;">
            <button id="add-job-btn" style="width:100%; padding:8px; border:1px dashed #ddd; background:#fafafa; color:#666; border-radius:6px; cursor:pointer; font-size:13px;"><i class="fa-solid fa-plus"></i> 追加</button>
        </div>
        <div style="text-align:right; margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <button id="save-job-btn" style="background:var(--accent-blue); color:white; border:none; padding:10px 25px; border-radius:6px; font-weight:bold; cursor:pointer;">保存</button>
        </div>
    </div>
</div>

<div id="settings-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:white; width:500px; max-width:90%; border-radius:12px; padding:20px; box-shadow:0 10px 25px rgba(0,0,0,0.2); display:flex; flex-direction:column; max-height:90vh;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">KPI項目設定</h3>
            <button id="close-settings-btn" style="border:none; background:none; font-size:24px; cursor:pointer; color:#999;">&times;</button>
        </div>
        <p style="font-size:12px; color:#666; margin-bottom:10px;">項目の並べ替え、表示設定、追加・削除ができます。<span style="color:#e02424;">※キー名はスプレッドシートの列名と一致させてください。</span></p>
        <div id="settings-list" style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:10px; margin-bottom:15px;"></div>
        <div style="margin-bottom:15px;"><button id="add-setting-btn" style="width:100%; padding:10px; border:2px dashed #ddd; background:#fafafa; color:#666; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.2s;"><i class="fa-solid fa-plus"></i> 新しい項目を追加</button></div>
        <div style="text-align:right; border-top:1px solid #eee; padding-top:15px;"><button id="save-settings-btn" style="background:var(--accent-blue); color:white; border:none; padding:10px 25px; border-radius:6px; font-weight:bold; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.1);">保存して反映</button></div>
    </div>
</div>

<div id="upload-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:white; width:400px; max-width:90%; border-radius:12px; padding:30px; box-shadow:0 10px 25px rgba(0,0,0,0.2); text-align:center;">
        <h3 style="margin-bottom:10px; color:var(--text-main);">日計表AIインポート</h3>
        <p style="font-size:13px; color:#666; margin-bottom:20px;">日計表の写真やPDF、Excelのスクリーンショットをアップロードしてください。<br>AIが数値を読み取り、自動入力します。</p>
        <div id="drop-area" style="border:2px dashed #ccc; border-radius:10px; padding:30px; margin-bottom:20px; cursor:pointer; background:#fafafa; transition:all 0.2s;"><i class="fa-solid fa-file-image" style="font-size:40px; color:#ccc; margin-bottom:10px;"></i><p style="font-size:14px; color:#999; margin:0;">ここにファイルをドラッグ<br>またはクリックして選択</p><input type="file" id="file-input" accept="image/*,application/pdf" style="display:none;"></div>
        <div id="preview-area" style="display:none; margin-bottom:20px;"><p id="file-name" style="font-size:12px; font-weight:bold; color:#333;"></p></div>
        <button id="upload-execute-btn" disabled style="background:#ccc; color:white; border:none; padding:12px 30px; border-radius:6px; font-weight:bold; cursor:not-allowed; width:100%;">AI解析スタート</button>
        <button id="close-upload-btn" style="margin-top:15px; border:none; background:none; color:#666; font-size:13px; cursor:pointer; text-decoration:underline;">キャンセル</button>
    </div>
</div>

<div id="input-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:white; width:600px; max-width:95%; border-radius:12px; padding:25px; box-shadow:0 10px 25px rgba(0,0,0,0.2); display:flex; flex-direction:column; max-height:90vh;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><h3 style="margin:0;">日次データ入力</h3><button id="close-input-btn" style="border:none; background:none; font-size:24px; cursor:pointer; color:#999;">&times;</button></div>
        <div style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:20px; display:flex; align-items:center; gap:10px; font-weight:bold; color:var(--text-main);"><label>対象日:</label><input type="date" id="input-target-date" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; font-family:inherit; font-size:16px; color:var(--text-main);"></div>
        <p style="font-size:12px; color:#666; margin-bottom:10px;">数値を入力して保存してください。既存のデータがある場合は上書きされます。</p>
        <div id="input-form-container" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:15px; overflow-y:auto; padding:5px; flex:1;"></div>
        <div style="text-align:right; border-top:1px solid #eee; padding-top:15px; margin-top:15px;"><button id="save-input-btn" style="background:var(--accent-blue); color:white; border:none; padding:10px 25px; border-radius:6px; font-weight:bold; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.1);"><i class="fa-solid fa-save"></i> 保存する</button></div>
    </div>
</div>

<script src="script.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCPWYzP72y42Kle1Q-MDQjUdlnPlDyifxc",
    authDomain: "decmo-hills--demo.firebaseapp.com",
    projectId: "decmo-hills--demo",
    storageBucket: "decmo-hills--demo.firebasestorage.app",
    messagingSenderId: "166692708725",
    appId: "1:166692708725:web:dc13314d3b98216f12733c",
    measurementId: "G-TJPQT3H28R"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const loginBtn = document.getElementById('login-btn');
  if(loginBtn) {
      loginBtn.addEventListener('click', () => {
        signInWithPopup(auth, provider).catch((error) => {
            console.error("Login Failed:", error);
            const errorMsg = document.getElementById('login-error');
            errorMsg.textContent = "ログインに失敗しました: " + error.message;
            errorMsg.style.display = 'block';
        });
      });
  }

  const logoutBtn = document.getElementById('logout-btn');
  if(logoutBtn) {
      logoutBtn.addEventListener('click', () => {
          if(confirm('ログアウトしますか？')) {
              signOut(auth).then(() => {
                  window.location.reload();
              }).catch((error) => {
                  console.error("Logout Error:", error);
                  alert("ログアウトに失敗しました");
              });
          }
      });
  }

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      document.getElementById('login-overlay').style.display = 'none';
      const userNameElem = document.querySelector('.user-name');
      if(userNameElem) userNameElem.textContent = user.displayName;
      if (user.photoURL) {
          const avatarDiv = document.querySelector('.user-info .avatar');
          if (avatarDiv) avatarDiv.innerHTML = `<img src="${user.photoURL}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
      }
      
      try {
          const token = await user.getIdToken();
          if (typeof window.startApp === 'function') {
              window.startApp(token);
          } else {
              setTimeout(() => {
                 if (typeof window.startApp === 'function') window.startApp(token);
              }, 500);
          }
      } catch(e) {
          console.error("Token error:", e);
      }
    } else {
      document.getElementById('login-overlay').style.display = 'flex';
    }
  });
</script>

</body>
</html>
